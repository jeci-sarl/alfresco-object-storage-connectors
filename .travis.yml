language: bash

services:
  - docker

script:
  - docker run --rm -v $(pwd):/root/sources -w /root/sources maven:3.3.9-jdk-8 mvn clean install -DskipTests=true -Dmaven.javadoc.skip=true -B -V

after_success:
  - if [ "$TRAVIS_TAG" ]; then
    docker build -t jeci/alfresco-platform-ceph-rados:$TRAVIS_TAG -t jeci/alfresco-platform-ceph-rados:latest alfresco-ceph-rados;
    docker build -t jeci/alfresco-platform-openio:$TRAVIS_TAG -t jeci/alfresco-platform-openio:latest alfresco-openio;
    docker build -t jeci/alfresco-platform-swift:$TRAVIS_TAG -t jeci/alfresco-platform-swift:latest alfresco-swift;
    docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
    docker push jeci/alfresco-platform-ceph-rados;
    docker push jeci/alfresco-platform-openio;
    docker push jeci/alfresco-platform-swift;
    fi

deploy:
  provider: releases
  api_key: ${GH_TOKEN}
  file:
    - "alfresco-ceph-rados/target/*.amp"
    - "alfresco-openio/target/*.amp"
    - "alfresco-swift/target/*.amp"
  file_glob: true
  skip_cleanup: true
  on:
    repo: jeci-sarl/alfresco-object-storage-connectors
    tags: true
